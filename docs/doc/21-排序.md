# 第21章 排序
## 21.1 SORT <key> 命令的实现

SORT 命令的最简单执行形式为：

```
SORT <key>
```

这个命令可以对一个包含数字值的键 `key` 进行排序。

以下示例展示了如何使用 SORT 命令对一个包含三个数字值的列表键进行排序：

```
redis> RPUSH numbers 3 1 2
(integer) 3

redis> SORT numbers
1) "1"
2) "2"
3) "3"
```

服务器执行 `SORT numbers` 命令的详细步骤如下：

1. 创建一个和 `numbers` 列表长度相同的数组， 该数组的每个项都是一个 `redis.h/redisSortObject` 结构， 如图 IMAGE_CREATE_ARRAY 所示。
2. 遍历数组， 将各个数组项的 `obj` 指针分别指向 `numbers` 列表的各个项， 构成 `obj` 指针和列表项之间的一对一关系， 如图 IMAGE_POINT_OBJ 所示。
3. 遍历数组， 将各个 `obj` 指针所指向的列表项转换成一个 `double` 类型的浮点数， 并将这个浮点数保存在相应数组项的 `u.score` 属性里面， 如图 IMAGE_SET_SCORE 所示。
4. 根据数组项 `u.score` 属性的值， 对数组进行数字值排序， 排序后的数组项按 `u.score` 属性的值从小到大排列， 如图 IMAGE_SORTED 所示。
5. 遍历数组， 将各个数组项的 `obj` 指针所指向的列表项作为排序结果返回给客户端： 程序首先访问数组的索引 `0` ， 返回 `u.score` 值为 `1.0` 的列表项 `"1"` ； 然后访问数组的索引 `1` ， 返回 `u.score` 值为 `2.0` 的列表项 `"2"` ； 最后访问数组的索引 `2` ， 返回 `u.score` 值为 `3.0` 的列表项 `"3"` 。

其他 `SORT <key>` 命令的执行步骤也和这里给出的 `SORT numbers` 命令的执行步骤类似。

![](../images/graphviz-50134101a2411c66a68e9089fefda31e01e649d9.png)

![](../images/graphviz-fa054d26e13d181296780a491b4fb559fb1ec8d7.png)

![](../images/graphviz-173ac0782ff3b828f9335886f6b097c1c649f165.png)

![](../images/graphviz-304b960a90fd953c18cfdd27c4fd0974823b7783.png)

以下是 `redisSortObject` 结构的完整定义：

```
typedef struct _redisSortObject {

    // 被排序键的值
    robj *obj;

    // 权重
    union {

        // 排序数字值时使用
        double score;

        // 排序带有 BY 选项的字符串值时使用
        robj *cmpobj;

    } u;

} redisSortObject;
```

SORT 命令为每个被排序的键都创建一个与键长度相同的数组， 数组的每个项都是一个 `redisSortObject` 结构， 根据 SORT 命令使用的选项不同， 程序使用 `redisSortObject` 结构的方式也不同， 稍后介绍 SORT 命令的各种选项时我们会看到这一点。

## 21.2 ALPHA 选项的实现
## 21.3 ASC 选项和DESC 选项的实现
## 21.4 BY选项的实现
## 21.5 带有ALPHA 选项的BY 选项的实现
## 21.6 LIMIT 选项的实现
## 21.7 GET选项的实现
## 21.8 STORE 选项的实现
## 21.9 多个选项的执行顺序
## 21.10 重点回顾

- SORT 命令通过将被排序键包含的元素载入到数组里面， 然后对数组进行排序来完成对键进行排序的工作。
- 在默认情况下， SORT 命令假设被排序键包含的都是数字值， 并且以数字值的方式来进行排序。
- 如果 SORT 命令使用了 `ALPHA` 选项， 那么 SORT 命令假设被排序键包含的都是字符串值， 并且以字符串的方式来进行排序。
- SORT 命令的排序操作由快速排序算法实现。
- SORT 命令会根据用户是否使用了 `DESC` 选项来决定是使用升序对比还是降序对比来比较被排序的元素， 升序对比会产生升序排序结果， 被排序的元素按值的大小从小到大排列， 降序对比会产生降序排序结果， 被排序的元素按值的大小从大到小排列。
- 当 SORT 命令使用了 `BY` 选项时， 命令使用其他键的值作为权重来进行排序操作。
- 当 SORT 命令使用了 `LIMIT` 选项时， 命令只保留排序结果集中 `LIMIT` 选项指定的元素。
- 当 SORT 命令使用了 `GET` 选项时， 命令会根据排序结果集中的元素， 以及 `GET` 选项给定的模式， 查找并返回其他键的值， 而不是返回被排序的元素。
- 当 SORT 命令使用了 `STORE` 选项时， 命令会将排序结果集保存在指定的键里面。
- 当 SORT 命令同时使用多个选项时， 命令先执行排序操作（可用的选项为 `ALPHA` 、 `ASC` 或 `DESC` 、 `BY` ）， 然后执行 `LIMIT` 选项， 之后执行 `GET` 选项， 再之后执行 `STORE` 选项， 最后才将排序结果集返回给客户端。
- 除了 `GET` 选项之外， 调整选项的摆放位置不会影响 SORT 命令的排序结果。